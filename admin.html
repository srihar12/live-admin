<!DOCTYPE html>
<html>
<head>
  <title>üè∏ Admin Panel</title>

  <style>
    body {
      font-family: Arial;
      padding: 20px;
      background: #f5f5f5;
    }

    input, select {
      padding: 6px;
      margin: 4px 0;
      width: 100%;
    }

    button {
      padding: 6px 12px;
      cursor: pointer;
      margin-top: 6px;
    }

    .box {
      background: white;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      width: 300px;
    }
  </style>
</head>

<body>

<h2>üè∏ Council Login</h2>

<!-- LOGIN -->
<div id="loginBox" class="box">
  <input id="username" placeholder="Username"><br>
  <input id="password" type="password" placeholder="Password"><br>
  <button onclick="login()">Login</button>
</div>


<!-- PANEL -->
<div id="panelBox" class="box" style="display:none">

  <h3>Enter Team No</h3>
  <input id="teamNoInput">
  <button onclick="loadTeam()">Fetch</button>

  <div id="formBox" style="display:none">

    <p>P1: <span id="p1"></span></p>
    <p>P2: <span id="p2"></span></p>

    <label>Status:</label>
    <select id="statusSelect" onchange="toggleFields()">
      <option>Not Scheduled</option>
      <option>Scheduled</option>
      <option>Completed - Not Scheduled Next Round</option>
      <option>Completed - Scheduled Next Round</option>
    </select>

    <!-- Scheduled -->
    <div id="scheduleBox" style="display:none">
      Opponent <input id="oppInput"><br>
      Court <input id="courtInput"><br>
      Time <input id="timeInput"><br>
    </div>

    <!-- Completed -->
    <div id="resultBox" style="display:none">
      Score <input id="scoreInput"><br>
      Result
      <select id="resultSelect">
        <option>Win</option>
        <option>Lost</option>
      </select>
    </div>

    <button onclick="save()">Save</button>
  </div>
</div>


<script>

/* ‚úÖ THIS FIXES RENDER + LOCAL BOTH */
const API = window.location.origin;

let currentRow = null;


// ---------------- LOGIN ----------------
async function login() {

  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;

  const res = await fetch(API + "/login", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ username, password })
  });

  const data = await res.json();

  if(data.success){
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("panelBox").style.display = "block";
  } else {
    alert("Invalid login");
  }
}


// ---------------- FETCH TEAM ----------------
async function loadTeam(){

  const teamNo = document.getElementById("teamNoInput").value;

  if(!teamNo){
    alert("Enter team number");
    return;
  }

  const res = await fetch(API + "/team/" + teamNo);
  const teamData = await res.json();

  if(!teamData.length){
    alert("Team not found");
    return;
  }

  document.getElementById("formBox").style.display = "block";

  currentRow = parseInt(teamNo) + 1;

  document.getElementById("p1").innerText = teamData[1];
  document.getElementById("p2").innerText = teamData[2];
}


// ---------------- TOGGLE FIELDS ----------------
function toggleFields(){

  const status = document.getElementById("statusSelect").value;

  const scheduleBox = document.getElementById("scheduleBox");
  const resultBox = document.getElementById("resultBox");

  scheduleBox.style.display = "none";
  resultBox.style.display = "none";

  if(status === "Scheduled"){
    scheduleBox.style.display = "block";
  }

  if(status === "Completed - Not Scheduled Next Round"){
    resultBox.style.display = "block";
  }

  if(status === "Completed - Scheduled Next Round"){
    scheduleBox.style.display = "block";
    resultBox.style.display = "block";
  }
}


// ---------------- SAVE ----------------
async function save(){

  const status = document.getElementById("statusSelect").value;

  let opponent="", courtVal="", timeVal="", scoreVal="", resultVal="";

  if(status === "Scheduled"){
    opponent = document.getElementById("oppInput").value;
    courtVal = document.getElementById("courtInput").value;
    timeVal = document.getElementById("timeInput").value;
  }

  if(status === "Completed - Not Scheduled Next Round"){
    scoreVal = document.getElementById("scoreInput").value;
    resultVal = document.getElementById("resultSelect").value;
  }

  if(status === "Completed - Scheduled Next Round"){
    opponent = document.getElementById("oppInput").value;
    courtVal = document.getElementById("courtInput").value;
    timeVal = document.getElementById("timeInput").value;
    scoreVal = document.getElementById("scoreInput").value;
    resultVal = document.getElementById("resultSelect").value;
  }

  // LOST ‚Üí clear next match
  if(resultVal === "Lost"){
    opponent="";
    courtVal="";
    timeVal="";
  }

  const row = [
    document.getElementById("teamNoInput").value,
    document.getElementById("p1").innerText,
    document.getElementById("p2").innerText,
    status,
    opponent,
    courtVal,
    timeVal,
    scoreVal,
    resultVal
  ];

  await fetch(API + "/updateTeam", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({
      rowIndex: currentRow,
      rowData: row
    })
  });

  alert("Saved to Google Sheet ‚úÖ");
}

</script>

</body>
</html>
